generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  OWNER
  ESTIMATOR
  TECH
}

enum AuthProvider {
  PASSWORD
  GOOGLE
}

model Org {
  id             Int       @id @default(autoincrement())
  name           String
  pricingTier    String?   @map("pricingtier")
  taxStatus      String?   @map("taxstatus")
  paymentTerms   String?   @map("paymentterms")
  businessAddress Json?    @map("business_address")
  proposalDefaults Json?   @map("proposal_defaults")
  createdAt      DateTime  @default(now()) @map("createdat")
  updatedAt      DateTime  @updatedAt @map("updatedat")
  users          User[]
  projects       Project[]
  clients        Client[]
  invites        Invite[]

  @@map("orgs")
}

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  name         String?
  passwordHash String   @map("passwordhash")
  authProvider AuthProvider @default(PASSWORD) @map("auth_provider")
  authProviderId String? @map("auth_provider_id")
  role         Role     @default(ESTIMATOR)
  orgId        Int      @map("orgid")
  org          Org      @relation(fields: [orgId], references: [id])
  emailVerifiedAt DateTime? @map("email_verified_at")
  mfaEnabled   Boolean  @default(false) @map("mfa_enabled")
  mfaSecret    String?  @map("mfa_secret")
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime @default(now()) @map("createdat")
  updatedAt    DateTime @updatedAt @map("updatedat")
  refreshTokens RefreshToken[]
  passwordResetTokens PasswordResetToken[]
  emailVerificationTokens EmailVerificationToken[]
  mfaChallenges MfaChallenge[]

  @@map("users")
}

model Invite {
  id         Int      @id @default(autoincrement())
  orgId      Int      @map("org_id")
  org        Org      @relation(fields: [orgId], references: [id])
  email      String
  role       Role     @default(ESTIMATOR)
  token      String   @unique
  createdBy  Int      @map("created_by")
  createdAt  DateTime @default(now()) @map("created_at")
  expiresAt  DateTime @map("expires_at")
  acceptedAt DateTime? @map("accepted_at")
  acceptedBy Int?     @map("accepted_by")
  revokedAt  DateTime? @map("revoked_at")

  @@map("invites")
  @@index([orgId, email], map: "invites_org_email_idx")
}

model Client {
  id        Int      @id @default(autoincrement())
  orgId     Int      @map("org_id")
  org       Org      @relation(fields: [orgId], references: [id])
  name      String
  email     String?
  phone     String?
  address   Json?
  notes     String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("clients")
  @@index([orgId], map: "clients_org_id_idx")
  @@index([email], map: "clients_email_idx")
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  user      User     @relation(fields: [userId], references: [id])
  tokenHash String   @map("token_hash")
  createdAt DateTime @default(now()) @map("created_at")
  expiresAt DateTime @map("expires_at")
  revokedAt DateTime? @map("revoked_at")

  @@map("refresh_tokens")
  @@index([userId], map: "refresh_tokens_user_id_idx")
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  user      User     @relation(fields: [userId], references: [id])
  tokenHash String   @map("token_hash")
  createdAt DateTime @default(now()) @map("created_at")
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")

  @@map("password_reset_tokens")
  @@index([userId], map: "password_reset_tokens_user_id_idx")
}

model EmailVerificationToken {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  user      User     @relation(fields: [userId], references: [id])
  tokenHash String   @map("token_hash")
  createdAt DateTime @default(now()) @map("created_at")
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")

  @@map("email_verification_tokens")
  @@index([userId], map: "email_verification_tokens_user_id_idx")
}

model MfaChallenge {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  user      User     @relation(fields: [userId], references: [id])
  tokenHash String   @map("token_hash")
  createdAt DateTime @default(now()) @map("created_at")
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")

  @@map("mfa_challenges")
  @@index([userId], map: "mfa_challenges_user_id_idx")
}

model Product {
  id               Int       @id @default(autoincrement()) @map("id")
  sku              String    @unique
  name             String
  description      String?   @db.Text
  category         String?
  familyId         Int?      @map("family_id")
  family           ProductFamily? @relation(fields: [familyId], references: [id])
  imageUrl         String?   @map("image_url")
  datasheetUrl     String?   @map("datasheet_url")
  media            Json?
  unitCost         Decimal?  @map("unit_cost")
  currency         String?
  msrp             Decimal?
  margin           Decimal?
  baseMargin       Decimal?  @map("base_margin")
  tierBaseDiscount Decimal?  @map("tier_base_discount")
  tierPlusDiscount Decimal?  @map("tier_plus_discount")
  volumeBreaks     Json?     @map("volume_breaks")
  leadTimeDays     Int?      @map("lead_time_days")
  stockBand        String?   @map("stock_band")
  facets           Json?
  variantFacets    Json?     @map("variant_facets")
  compatRequires   Json?     @map("compat_requires")
  compatBlocks     Json?     @map("compat_blocks")
  bundleComponents String?   @map("bundle_components")
  supplier         Json?
  pricing          Json?
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @default(now()) @updatedAt @map("updated_at")
  lineItems        LineItem[]
  @@map("products")
  @@index([familyId], map: "products_family_id_idx")
}

model ProductFamily {
  id           Int       @id @default(autoincrement())
  name         String
  brand        String?
  category     String?
  description  String?
  defaultImage String?
  attributes   Json?
  products     Product[]
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @default(now()) @updatedAt @map("updated_at")

  @@map("product_families")
  @@index([name, brand], map: "product_families_name_brand_idx")
}

enum ProjectStatus {
  DRAFT   @map("DRAFT")
  QUOTED  @map("QUOTED")
  ORDERED @map("ORDERED")

  @@map("project_status")
}

model Project {
  id          Int           @id @default(autoincrement())
  orgId       Int           @map("org_id")
  org         Org           @relation(fields: [orgId], references: [id])
  name        String
  clientMeta  Json?         @map("client_meta")
  proposalMeta Json?        @map("proposal_meta")
  status      ProjectStatus @default(DRAFT)
  archivedAt  DateTime?     @map("archived_at")
  createdBy   Int           @map("created_by")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  rooms       Room[]
  lineItems   LineItem[]
  bomVersions BOMVersion[]
  orders      Order[]

  @@map("projects")
}

model Room {
  id        Int      @id @default(autoincrement())
  projectId Int      @map("project_id")
  project   Project  @relation(fields: [projectId], references: [id])
  name      String
  notes     String?
  lineItems LineItem[]

  @@map("rooms")
}

model LineItem {
  id         Int      @id @default(autoincrement())
  projectId  Int      @map("project_id")
  project    Project  @relation(fields: [projectId], references: [id])
  roomId     Int?     @map("room_id")
  room       Room?    @relation(fields: [roomId], references: [id])
  productId  Int?     @map("product_id")
  product    Product? @relation(fields: [productId], references: [id])
  qty        Int
  unitPrice  Decimal? @map("unit_price")
  discounts  Json?
  notes      String?
  source     String?
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("line_items")
}

model BOMVersion {
  id         Int      @id @default(autoincrement())
  projectId  Int      @map("project_id")
  project    Project  @relation(fields: [projectId], references: [id])
  snapshot   Json
  totals     Json?
  proposalResponse Json?  @map("proposal_response")
  shareId    String?  @unique @map("share_id")
  createdBy  Int      @map("created_by")
  createdAt  DateTime @default(now()) @map("created_at")
  orders     Order[]

  @@map("bom_versions")
}

enum OrderStatus {
  DRAFT     @map("DRAFT")
  SENT      @map("SENT")
  ACCEPTED  @map("ACCEPTED")
  FULFILLED @map("FULFILLED")
  SHIPPED   @map("SHIPPED")
  CANCELLED @map("CANCELLED")

  @@map("order_status")
}

enum OrderType {
  QUOTE @map("QUOTE")
  PO    @map("PO")

  @@map("order_type")
}

enum PaymentProvider {
  PAYSTACK
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

model Order {
  id           Int         @id @default(autoincrement())
  projectId    Int         @map("project_id")
  project      Project     @relation(fields: [projectId], references: [id])
  bomVersionId Int         @map("bom_version_id")
  bomVersion   BOMVersion  @relation(fields: [bomVersionId], references: [id])
  type         OrderType   @default(QUOTE)
  status       OrderStatus @default(DRAFT)
  shipping     Json?
  tax          Json?
  total        Decimal?
  tracking     Json?
  shareId      String?     @unique @map("share_id")
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")
  payments     Payment[]

  @@map("orders")
}

model Payment {
  id               Int             @id @default(autoincrement())
  orderId          Int             @map("order_id")
  order            Order           @relation(fields: [orderId], references: [id])
  provider         PaymentProvider @default(PAYSTACK)
  status           PaymentStatus   @default(PENDING)
  amount           Decimal
  currency         String
  reference        String          @unique
  authorizationUrl String?         @map("authorization_url")
  accessCode       String?         @map("access_code")
  metadata         Json?
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")

  @@map("payments")
  @@index([orderId], map: "payments_order_id_idx")
}
